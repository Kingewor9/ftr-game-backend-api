<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTR League Game</title>
    <!-- Mandatory script for Telegram Web Apps -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS to match Telegram's theme and make it full screen */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: var(--tg-theme-header-bg-color, #5865f2);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
        }
        .content {
            padding: 20px;
            flex-grow: 1;
        }
        .nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--tg-theme-bg-color, #fff);
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #ccc);
        }
        .nav-button {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color, #999);
            cursor: pointer;
            padding: 10px;
            font-size: 0.9em;
        }
        .nav-button.active {
            color: var(--tg-theme-link-color, #007bff);
            font-weight: bold;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #fff);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tg-button {
             background-color: var(--tg-theme-button-color, #007bff);
             color: var(--tg-theme-button-text-color, #ffffff);
             border: none;
             padding: 10px 15px;
             border-radius: 5px;
             font-weight: bold;
             cursor: pointer;
             margin-top: 10px;
             width: 100%; /* Default to full width for better mobile experience */
             transition: background-color 0.2s;
        }
        .tg-button:active {
            filter: brightness(85%);
        }
        /* Style for critical error message */
        .critical-error {
            color: var(--tg-theme-destructive-text-color, #ff0000);
            background-color: var(--tg-theme-secondary-bg-color, #fdd);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #333);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
            padding-bottom: 5px;
        }
        .modal-content input[type="text"],
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-buttons .tg-button {
            width: auto;
            margin-top: 0;
        }
        .modal-buttons .cancel-btn {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body>
    <!-- Persistent state storage for authenticated Telegram ID -->
    <input type="hidden" id="auth-telegram-id" value="" />
    
    <div class="header">Footy Riddles</div>

    <div class="content">
        <!-- HOME VIEW -->
        <div id="home-view" style="display: none;">
            <h2>Welcome!</h2>
            <p id="username-display">Loading...</p> 
            <div class="card">
                <h3>Today's Quiz</h3>
                <p id="quiz-status">Checking for daily quiz...</p>
                <button id="start-quiz-btn" class="tg-button" style="display: none;">Start Quiz</button>
            </div>
        </div>

        <!-- LEAGUE VIEW -->
        <div id="league-view" style="display: none;">
            <h2>My Leagues</h2>
            <div id="leagues-list">Waiting for user authentication...</div>
            <!-- The Create League button now opens the modal -->
            <button id="create-league-btn" class="tg-button">Create New League</button>
            <button id="join-league-btn" class="tg-button" style="background-color: var(--tg-theme-hint-color);">Join League via Code</button>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profile-view" style="display: none;">
            <h2>My Profile</h2>
            <div id="profile-details">Loading profile...</div>
        </div>
    </div>

    <!-- NAVIGATION BAR -->
    <div class="nav">
        <button class="nav-button" data-view="home">üè† Home</button>
        <button class="nav-button" data-view="league">üèÜ Leagues</button>
        <button class="nav-button" data-view="profile">üë§ Profile</button>
    </div>

    <!-- CREATE LEAGUE MODAL -->
    <div id="create-league-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Create New League</h3>
            <form id="create-league-form">
                <label for="league-name" style="font-size: 0.9em; display: block; margin-bottom: 5px;">League Name</label>
                <input type="text" id="league-name" placeholder="E.g., Champions Challenge" required maxlength="50">
                
                <label for="league-description" style="font-size: 0.9em; display: block; margin-bottom: 5px;">Description (e.g., Rules or goal)</label>
                <!-- NEW TEXT AREA FOR DESCRIPTION -->
                <textarea id="league-description" placeholder="A friendly league for the office staff..." required maxlength="200" rows="3"></textarea>
                
                <label for="is-private" style="font-size: 0.9em; display: block; margin-bottom: 15px;">
                    <input type="checkbox" id="is-private" checked> Private League (Requires Invite Code)
                </label>
                
                <div id="league-creation-status" style="margin-top: 10px; font-size: 0.9em; color: var(--tg-theme-link-color);"></div>

                <div class="modal-buttons">
                    <button type="button" class="tg-button cancel-btn" onclick="closeCreateLeagueModal()">Cancel</button>
                    <button type="submit" class="tg-button">Create League</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = ''; // Platform will proxy this
        
        const webApp = window.Telegram.WebApp;

        // 1. Initialize the WebApp
        if (webApp) {
            webApp.ready();
            webApp.expand(); // Use full screen
            // Apply theme parameters globally
            if (webApp.themeParams) {
                document.body.style.backgroundColor = webApp.themeParams.bg_color;
                document.body.style.color = webApp.themeParams.text_color;
                // You can also adjust primary colors here if needed
            }
        } else {
             document.getElementById('username-display').innerText = "ERROR: Telegram WebApp not detected.";
        }
        
        // --- State Helper ---
        /** Reads the authenticated user ID from the hidden DOM element. */
        function getUserId() {
            const idInput = document.getElementById('auth-telegram-id');
            // Returns the ID string or null if the input is not found or empty
            return idInput ? idInput.value : null; 
        }

        // --- Telegram Alert Safety Helper ---
        /** Truncates and sanitizes a message before displaying it via Telegram's showAlert. */
        function showTwaAlert(message) {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                const MAX_LENGTH = 150; // Use a safe maximum length
                // Truncate message if too long
                const displayMessage = message.length > MAX_LENGTH 
                    ? message.substring(0, MAX_LENGTH - 3) + '...'
                    : message;
                
                // Remove potential HTML/special chars that could break the native function
                const cleanMessage = displayMessage.replace(/<\/?[^>]+(>|$)/g, "").trim(); 

                webApp.showAlert(cleanMessage);
            } else {
                console.error("ALERT (TWA Missing):", message);
            }
        }


        // --- Utility Functions ---
        /** Recursively searches the response object for any key named 'id', 'user_id', or 'telegram_id'
         * and returns its value if it looks like a numeric ID.
         */
        function findIdRecursively(obj, targetKeys = ['id', 'user_id', 'uid', 'telegram_id']) {
            if (typeof obj !== 'object' || obj === null) return null;

            for (const key in obj) {
                if (!obj.hasOwnProperty(key)) continue;

                const value = obj[key];
                
                // 1. Check if the current key is a target key and the value is a valid ID format
                if (targetKeys.includes(key.toLowerCase())) {
                    if (value && (typeof value === 'number' || (typeof value === 'string' && /^\d+$/.test(value)))) {
                         console.log(`[DEBUG] Found ID under key: ${key}`);
                         return String(value); // Return as string
                    }
                }
                
                // 2. Recurse into nested objects or arrays
                if (typeof value === 'object' && value !== null) {
                    const result = findIdRecursively(value, targetKeys);
                    if (result) return result;
                }
            }
            return null;
        }


        async function fetchAPI(endpoint, method = 'POST', data = {}) {
            const methodUpper = method.toUpperCase();
            const currentUserId = getUserId(); 
            
            let fetchUrl = `${API_URL}${endpoint}`;
            let fetchOptions = { method: methodUpper };
            
            // For POST/PUT/DELETE, send ID in JSON body
            if (['POST', 'PUT', 'DELETE'].includes(methodUpper)) {
                let finalData = { ...data }; 
                if (currentUserId && endpoint !== '/auth/login') {
                    // Automatically add the authenticated user ID for secured endpoints
                    finalData.telegram_id = currentUserId; 
                }
                
                fetchOptions.headers = { 'Content-Type': 'application/json' };
                fetchOptions.body = JSON.stringify(finalData);
            
            } else if (methodUpper === 'GET') {
                // For GET, add the ID as a query parameter if explicitly needed (not used for daily_info anymore)
                const params = new URLSearchParams();
                if (currentUserId && data.include_user_id) { 
                     params.append('telegram_id', currentUserId);
                }
                
                const queryString = params.toString();
                if (queryString) {
                    fetchUrl += `?${queryString}`;
                }
            }
            
            try {
                const response = await fetch(fetchUrl, fetchOptions);

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => response.text());
                    
                    let errorMessage = `API Error ${response.status} on ${fetchUrl}.`;
                    if (response.status === 422) {
                        const detail = typeof errorBody === 'object' ? JSON.stringify(errorBody.detail) : errorBody;
                        errorMessage = `API Validation Failed (422). Server details: ${detail}`;
                    } else if (response.status === 404) {
                        errorMessage = `API Error 404: Endpoint ${endpoint} Not Found.`;
                    } else {
                        errorMessage += " Server response: " + (typeof errorBody === 'object' ? JSON.stringify(errorBody) : errorBody);
                    }
                    
                    console.error("Fetch API Error:", errorMessage);
                    // Use the safe TWA alert function here
                    showTwaAlert(errorMessage); 
                    throw new Error(errorMessage);
                }

                return response.json();

            } catch (error) {
                console.error("Network or Processing Error:", error);
                if (error.message.includes("Failed to fetch")) {
                     // Use the safe TWA alert function here
                     showTwaAlert("Backend Unreachable. Check deployment status.");
                } else {
                     // Check if this is a custom error message thrown by us
                     if (!error.message.includes("API Error")) {
                        // Use the safe TWA alert function here
                        showTwaAlert(`Request Failed: ${error.message}`);
                     }
                }
                
                return { error: error.message };
            }
        }

        // --- 2. AUTHENTICATION (Deep ID Extraction) ---
        async function authenticateUser() {
            const displayElement = document.getElementById('username-display');
            displayElement.innerText = "Authenticating...";
            displayElement.classList.remove('critical-error');

            if (!webApp || !webApp.initData) {
                displayElement.innerText = "Error: Please run this inside Telegram.";
                return null;
            }

            try {
                const loginUrl = `${API_URL}/auth/login`;
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: webApp.initData 
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Login failed with status ${response.status}. Response: ${errorText}`);
                }

                const data = await response.json();
                
                // ROBUST DEEP ID EXTRACTION
                const telegramId = findIdRecursively(data);

                if (!telegramId) {
                    const criticalMessage = `Authentication Failed: ID missing. Server Response Structure: ${JSON.stringify(data, null, 2)}`;
                    console.error(`[CRITICAL DIAGNOSTIC] ${criticalMessage}`);
                    
                    displayElement.innerHTML = `<span class="critical-error">Authentication Failed: ID not found in server response.<br>Please copy the full error from the console.</span>`;
                    // Use the safe TWA alert function here
                    showTwaAlert("Failed to authenticate. ID not found in server response.");
                    return null;
                }
                
                // Store ID persistently in the hidden DOM field
                document.getElementById('auth-telegram-id').value = telegramId;
                
                // SUCCESS: Display only the welcome message (no ID)
                displayElement.innerHTML = `Welcome back, <strong>${webApp?.initDataUnsafe?.user?.first_name || 'Player'}</strong>!`;
                
                console.log(`[AUTH SUCCESS] User ID successfully extracted and stored.`);
                
                return telegramId;
                
            } catch (error) {
                console.error("Authentication Error:", error);
                displayElement.innerHTML = `<span class="critical-error">Authentication Failed: ${error.message}</span>`;
                // Use the safe TWA alert function here
                showTwaAlert("Could not log you in. Please refresh the app.");
                return null;
            }
        }

        // --- 3. DATA LOADING FUNCTIONS ---
        async function loadHomeData() {
            document.getElementById('quiz-status').innerText = "Checking for daily quiz...";
            
            // Confirmed working endpoint: /quiz/daily_info (POST)
            const quizEndpoint = '/quiz/daily_info'; 
            // fetchAPI handles POST and automatically includes telegram_id in the body
            const quizData = await fetchAPI(quizEndpoint, 'POST', {}); 
            
            const quizStatusElement = document.getElementById('quiz-status');
            const startQuizBtn = document.getElementById('start-quiz-btn');

            if (quizData.error) {
                quizStatusElement.innerText = "Error loading daily quiz data. See console for details.";
                startQuizBtn.style.display = 'none';
            } else {
                // Assuming successful response structure:
                quizStatusElement.innerHTML = `<strong>${quizData.quiz_name || 'Daily Quiz'}</strong> (${quizData.questions_count || 5} Qs, ${quizData.points_per_question || 10} pts/Q)`;
                startQuizBtn.style.display = 'block';
                // Use the safe TWA alert function here
                startQuizBtn.onclick = () => showTwaAlert("Quiz starting logic goes here!"); 
            }
        }

        async function loadLeagues() {
            const leagueListElement = document.getElementById('leagues-list');
            const currentUserId = getUserId();
            
            if (!currentUserId) {
                leagueListElement.innerText = "Error: Authentication token missing. Please refresh the app.";
                return;
            }
            
            leagueListElement.innerHTML = '<p>Fetching your leagues...</p>';

            // fetchAPI will automatically include the string ID in the POST payload
            const data = await fetchAPI('/league/my_leagues', 'POST', {}); 
            
            if (data.error) {
                leagueListElement.innerText = "Failed to load leagues. See console for API error.";
                return;
            }

            if (data.my_leagues && data.my_leagues.length > 0) {
                let html = '<ul style="list-style: none; padding: 0;">';
                data.my_leagues.forEach(league => {
                    html += `<li class="card">
                        <h4 style="margin-top: 0; color: var(--tg-theme-text-color);">${league.league_name}</h4>
                        <p style="margin: 5px 0;">Rank: <strong>#${league.user_rank || 'N/A'}</strong> | Points: <strong>${league.user_points || 0}</strong></p>
                        <button class="tg-button" style="width: auto; margin-top: 5px; padding: 8px 12px; font-size: 0.9em;" onclick="showTwaAlert('View Table for ${league.league_name} logic goes here')">View Leaderboard</button>
                    </li>`;
                });
                html += '</ul>';
                leagueListElement.innerHTML = html;
            } else {
                leagueListElement.innerHTML = "<p>You are not a member of any leagues yet. Create or Join one!</p>";
            }
        }
        
        // Function to display profile data
        function loadProfileData() {
             const profileDetailsElement = document.getElementById('profile-details');
             
             // NOTE: Telegram ID is intentionally hidden from the UI as per user request.
             
             profileDetailsElement.innerHTML = `
                <div class="card">
                    <p><strong>Username:</strong> ${webApp?.initDataUnsafe?.user?.username || 'N/A'}</p>
                    <p><strong>First Name:</strong> ${webApp?.initDataUnsafe?.user?.first_name || 'N/A'}</p>
                    <hr style="border: 0; border-top: 1px solid var(--tg-theme-hint-color);">
                    <p><strong>Total Quizzes Played:</strong> 0 (Mock)</p>
                    <p><strong>Overall Score:</strong> 0 (Mock)</p>
                </div>
             `;
        }
        
        // --- 4. VIEW SWITCHING & INIT ---
        /** Manually switches the view and updates the navigation buttons. */
        function switchView(view) {
             // 1. Switch visibility
            document.getElementById('home-view').style.display = view === 'home' ? 'block' : 'none';
            document.getElementById('league-view').style.display = view === 'league' ? 'block' : 'none';
            document.getElementById('profile-view').style.display = view === 'profile' ? 'block' : 'none';
            
            // 2. Update active state
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav-button[data-view="${view}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // 3. Load data based on view
            const currentUserId = getUserId();
            
            if (currentUserId) {
                if (view === 'league') {
                    loadLeagues(); // Load leagues on demand
                } else if (view === 'home') {
                    loadHomeData(); // Load home data on demand
                } else if (view === 'profile') {
                    loadProfileData();
                }
            } else {
                 document.getElementById('leagues-list').innerText = "Authentication is required to view leagues.";
            }
        }

        // --- 5. LEAGUE CREATION MODAL LOGIC ---
        function openCreateLeagueModal() {
            document.getElementById('create-league-modal').style.display = 'flex';
            document.getElementById('league-creation-status').innerText = ''; // Clear previous status
        }

        function closeCreateLeagueModal() {
            document.getElementById('create-league-modal').style.display = 'none';
            document.getElementById('create-league-form').reset(); // Clear form inputs
        }

        async function handleCreateLeague(event) {
            event.preventDefault(); // Stop default form submission
            
            const statusElement = document.getElementById('league-creation-status');
            const leagueName = document.getElementById('league-name').value.trim();
            // NEW: Get description value
            const leagueDescription = document.getElementById('league-description').value.trim();
            const isPrivate = document.getElementById('is-private').checked;

            if (!leagueName || !leagueDescription) {
                statusElement.innerText = "League name and description are required!";
                return;
            }
            
            statusElement.innerText = 'Creating league...';

            // FIX: Including 'description' and confirming 'name'
            const leagueData = {
                name: leagueName, 
                description: leagueDescription, // Added description field
                is_private: isPrivate,
                // telegram_id is automatically added by fetchAPI helper
            };

            // Using the confirmed correct path: /league/create
            const data = await fetchAPI('/league/create', 'POST', leagueData);

            if (data.error) {
                statusElement.style.color = 'var(--tg-theme-destructive-text-color)';
                statusElement.innerText = `Creation Failed: ${data.error.substring(0, 500)}`;
            } else {
                statusElement.style.color = 'var(--tg-theme-link-color)';
                // Assuming successful response includes the new league ID or name
                statusElement.innerHTML = `League <strong>${data.league_name || leagueName}</strong> created successfully! <br> Code: <strong>${data.invite_code || 'TBD'}</strong>`;
                
                // Close modal after a delay and refresh league list
                setTimeout(() => {
                    closeCreateLeagueModal();
                    loadLeagues(); // Refresh the list to show the new league
                }, 1500); 
            }
        }

        // --- 6. INITIALIZATION & EVENT LISTENERS ---
        async function initApp() {
            const userId = await authenticateUser();

            if (userId) {
                // Start on the Leagues tab
                switchView('league'); 
            } else {
                // If auth fails, show home with the error message
                switchView('home'); 
            }
        }
        
        // Navigation listener
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const view = e.target.getAttribute('data-view');
                if (view) switchView(view);
            });
        });

        // "Create League" button opens the modal
        document.getElementById('create-league-btn').addEventListener('click', openCreateLeagueModal);
        
        // Form submission listener for league creation
        document.getElementById('create-league-form').addEventListener('submit', handleCreateLeague);

        // Initial call to start the process
        initApp();
        
    </script>
</body>
</html>
